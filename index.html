<html lang="ja"><head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>fulipl</title>
</head>

<body onload="initw()">

    <canvas id="canvas" width="1358" height="660" tabindex="1"></canvas>
    <select name="menselect" id="MenSelect" onchange="change(this)">

    <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option><option value="31">31</option><option value="32">32</option><option value="33">33</option><option value="34">34</option><option value="35">35</option><option value="36">36</option><option value="37">37</option><option value="38">38</option><option value="39">39</option><option value="40">40</option><option value="41">41</option><option value="42">42</option><option value="43">43</option><option value="44">44</option><option value="45">45</option><option value="46">46</option><option value="47">47</option><option value="48">48</option><option value="49">49</option><option value="50">50</option><option value="51">51</option><option value="52">52</option><option value="53">53</option><option value="54">54</option><option value="55">55</option><option value="56">56</option><option value="57">57</option><option value="58">58</option><option value="59">59</option><option value="60">60</option><option value="61">61</option><option value="62">62</option><option value="63">63</option><option value="64">64</option><option value="65">65</option><option value="66">66</option><option value="67">67</option><option value="68">68</option><option value="69">69</option><option value="70">70</option><option value="71">71</option><option value="72">72</option><option value="73">73</option><option value="74">74</option><option value="75">75</option><option value="76">76</option><option value="77">77</option><option value="78">78</option><option value="79">79</option><option value="80">80</option><option value="81">81</option><option value="82">82</option><option value="83">83</option><option value="84">84</option><option value="85">85</option><option value="86">86</option><option value="87">87</option><option value="88">88</option><option value="89">89</option><option value="90">90</option><option value="91">91</option><option value="92">92</option><option value="93">93</option><option value="94">94</option><option value="95">95</option><option value="96">96</option><option value="97">97</option><option value="98">98</option><option value="99">99</option><option value="100">100</option><option value="101">101</option><option value="102">102</option><option value="103">103</option><option value="104">104</option><option value="105">105</option><option value="106">106</option><option value="107">107</option><option value="108">108</option><option value="109">109</option><option value="110">110</option><option value="111">111</option><option value="112">112</option><option value="113">113</option></select>
    <script>
        var canvas;
        var context;
        var map_b = [
            [-2, -3, -3, -3, -3, -3, -3, -3, -3, -3, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2],
            [-2, -3, -3, -3, -3, -1, -1, -1, 0, 1, 2, 3, 4, 5, -1, -1, -1, -2, -2, -2, -2, -2],
            [-2, -3, -3, -3, -1, -1, -1, -1, 6, 7, 8, 9, 10, 11, -1, -1, -1, -1, -2, -2, -2, -2],
            [-2, -3, -3, -1, -1, -1, -1, -1, 12, 13, 14, 15, 16, 17, -1, -1, -1, -1, -1, -2, -2, -2],
            [-2, -3, -1, -1, -1, -1, -1, -1, 18, 19, 20, 21, 22, 23, -1, -1, -1, -1, -1, -1, -2, -2],
            [-2, -1, -1, -1, -1, -1, -1, -1, 24, 25, 26, 27, 28, 29, -1, -1, -1, -1, -1, -1, -1, -2],
            [-2, -1, -1, -1, -1, -1, -1, -1, 30, 31, 32, 33, 34, 35, -1, -1, -1, -1, -1, -1, -1, -2],
            [-2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -2],
            [-2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -2],
            [-2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -2],
            [-2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -2],

        ];

        var map = [];
        var wordlist = [];
        var wordchklist = [];
        //自機座標
        var jx = 1;
        var jy = 10;
        var blx = 0;
        var bly = 0;
        var jikino = 36;
        //キーフラグ
        var block_up = false;
        var block_right = false;
        var block_left = false;
        var key_left = false;
        var key_right = false;

        var character;
        var speed = 0;
        var pjx = 0;
        var pjy = 0;
        const suon = new Audio('thow.mp3');
        const sumiss = new Audio('no.mp3');
        const suget = new Audio('pi.mp3');

        function initw() {
            character = new Image();
            character.src = "ji.png";
            canvas = document.getElementById('canvas');
            context = canvas.getContext('2d');
            canvas.focus();
            document.addEventListener("keydown", keyDownHandler, false);
            document.addEventListener("keyup", keyUpHandler, false);

            canvas.addEventListener('click', click, false);
            canvas.addEventListener("touchstart", touchstart, false);
            canvas.addEventListener("touchend", touchend, false);
            canvas.addEventListener("touchmove", touchmove, false);
            canvas.addEventListener("touchstart", touchstart, false);
            canvas.addEventListener("touchend", touchend, false);
            canvas.addEventListener("touchmove", touchmove, false);


            var select = document.getElementById("MenSelect");

            for (i = 0; i < 2035 * 2 / 36; i++) {
                var option = document.createElement("option");
                option.text = i;
                option.value = i;
                select.appendChild(option);
            }


            for (i = 0; i < map_b.length; i++) {
                ar = new Array(map_b[0].length);
                map.push(ar);
            }
            newgame(0);
            Onanime();

            //chckdouble(); //重複検査　リストを新しくしたら一回呼ぶ
            //重複があったら　文言を変えるとか　リストの遠い所に置くとか
        }
        var nowg = 0;
        function newgame(base) {
            nowg = base;
            wordlist.splice(0)
            wordchklist.splice(0)
            jikino = 36;
            for (i = base * 36; i < 36 + base * 36; i++) {
                wordlist.push(words[i]);
                wordchklist.push(words[i]);
            }
            wordlist.push("");
            for (let i = 0; i < map.length; i++) {
                for (let f = 0; f < map[0].length; f++) {
                    map[i][f] = map_b[i][f];
                }
            }
            for (i = 0; i < 1000; i++) {
                var no = getRandomInt(0, 35);
                var tmp = wordlist[no];
                var no2 = getRandomInt(0, 35);
                wordlist[no] = wordlist[no2];
                wordlist[no2] = tmp;
            }


        }
        function chckdouble() {
            for (st = 0; st < 113; st++) {
                wordlist.splice(0)
                for (i = st * 36; i < 36 + st * 36; i++) {
                    wordlist.push(words[i]);
                }

                var tyo = wordlist.filter(function (x, i, self) {
                    return self.indexOf(x) !== self.lastIndexOf(x);
                });
            }
        }
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1) + min); //The maximum is inclusive and the minimum is inclusive
        }
        function Onanime() {
            speed++;
            if (speed % 4 == 0) {
                requestAnimationFrame(Onanime);
                return;
            }

            if (pjx != 0 && pjy != 0) {
                if (jx * 60 + 30 <= pjx) key_left = false;
                if (jx * 60 + 30 >= pjx) key_right = false;
                if (jy * 60 + 30 <= pjy) key_up = false;
                if (jy * 60 + 30 >= pjy) key_down = false;
            }

            if (key_right) {
                if (map[jy][jx + 1] == -1) {
                    jx++;
                    key_right = false
                }
            }
            if (key_left) {
                if (map[jy][jx - 1] == -1) {
                    jx--;
                    key_left = false
                }
            }

            if (block_up) {
                if (map[bly - 1][blx] == -1) {
                    bly = bly - 1;
                } else {
                    block_up = false;
                    if (map[bly - 1][blx] == -2) {
                        block_right = true;
                        sumiss.currentTime = 0;
                        sumiss.play();
                    }
                    if (map[bly - 1][blx] == -3) {
                        block_left = true;
                        sumiss.currentTime = 0;
                        sumiss.play();
                    }
                    if (map[bly - 1][blx] >= 0) {
                        var wno = wordchklist.indexOf(wordlist[jikino]);
                        var lno = map[bly - 1][blx];
                        var wno2 = wordchklist.indexOf(wordlist[lno]);


                        if (Math.floor(wno / 2) == Math.floor(wno2 / 2)) {
                            map[bly - 1][blx] = -1;
                            jikino = 36;
                            suget.currentTime = 0;
                            suget.play();
                        } else {
                            if (jikino == 36) {
                                jikino = map[bly - 1][blx];
                                map[bly - 1][blx] = -1;

                            } else {
                                var tmp = map[bly - 1][blx];
                                map[bly - 1][blx] = jikino;
                                jikino = tmp;
                            }
                            sumiss.currentTime = 0;
                            sumiss.play();
                        }
                    }
                }
            } else if (block_right) {
                if (map[bly][blx - 1] == -1) {
                    blx = blx - 1;
                } else {
                    if (map[bly][blx - 1] >= 0) {
                        var wno = wordchklist.indexOf(wordlist[jikino]);
                        var lno = map[bly][blx - 1];
                        var wno2 = wordchklist.indexOf(wordlist[lno]);

                        if (Math.floor(wno / 2) == Math.floor(wno2 / 2)) {
                            map[bly][blx - 1] = -1;
                            suget.currentTime = 0;
                            suget.play();
                            jikino = 36;
                        }
                        else {
                            if (jikino == 36) {
                                jikino = map[bly][blx - 1];
                                map[bly][blx - 1] = -1;
                            } else {
                                var tmp = map[bly][blx - 1];
                                map[bly][blx - 1] = jikino;
                                jikino = tmp;
                            }
                            sumiss.currentTime = 0;
                            sumiss.play();
                        }
                    }
                    block_right = false;
                }
            } else if (block_left) {
                if (map[bly][blx + 1] == -1) {
                    blx = blx + 1;
                } else {
                    if (map[bly][blx + 1] >= 0) {
                        var wno = wordchklist.indexOf(wordlist[jikino]);
                        var lno = map[bly][blx + 1];
                        var wno2 = wordchklist.indexOf(wordlist[lno]);

                        if (Math.floor(wno / 2) == Math.floor(wno2 / 2)) {
                            map[bly][blx + 1] = -1;
                            jikino = 36;
                            suget.currentTime = 0;
                            suget.play();
                        } else {
                            if (jikino == 36) {
                                jikino = map[bly][blx + 1];
                                map[bly][blx + 1] = -1;
                            } else {
                                var tmp = map[bly][blx + 1];
                                map[bly][blx + 1] = jikino;
                                jikino = tmp;
                            }
                            sumiss.currentTime = 0;
                            sumiss.play();
                        }
                    }
                    block_left = false;
                }

            } else {
                bly = jy - 1;
                blx = jx;
            }

            draw();
            var cl = clearchk();
            if (cl) requestAnimationFrame(Onanime);
        }
        function draw() {
            context.fillStyle = 'Black';
            context.fillRect(0, 0, 1320, 660);
            var wordno = 0;
            for (let i = 0; i < map.length; i++) {
                for (let f = 0; f < map[0].length; f++) {
                    if (map[i][f] >= 0) {
                        context.fillStyle = 'White';
                        context.font = '15px Arial'; // 文字の大きさとフォントを設定
                        context.fillRect(f * 60, i * 60, 58, 58);

                        context.fillStyle = 'green';
                        context.fillRect(f * 60 + 2, i * 60 + 2, 56, 56);
                        context.fillStyle = 'White';
                        wordno = map[i][f];
                        context.fillText(wordlist[wordno], f * 60 + 3, i * 60 + 30, 55);

                    }
                    if (map[i][f] <= -2) {
                        context.fillStyle = 'White';
                        context.fillRect(f * 60, i * 60, 58, 58);

                        context.fillStyle = 'gray';
                        context.fillRect(f * 60 + 2, i * 60 + 2, 56, 56);
                    }
                }
            }

            context.drawImage(character, jx * 60, jy * 60, 60, 60);

            context.fillStyle = 'White';
            context.fillRect(blx * 60, bly * 60, 58, 58);

            context.fillStyle = 'darkred';
            context.fillRect(blx * 60 + 2, bly * 60 + 2, 56, 56);

            context.fillStyle = 'White';
            context.fillText(wordlist[jikino], blx * 60 + 4, bly * 60 + 30, 55);
        }
        function change(event) {
            newgame(event.value);
            console.log(event.value);
        }
        function clearchk() {
            var counter = 0;
            for (let i = 0; i < map.length; i++) {
                for (let f = 0; f < map[0].length; f++) {
                    if (map[i][f] >= 0) {
                        counter++;
                    }
                }
            }
            if (counter == 0) {
                var result = confirm('もう一度遊びますか？');

                if (result) {
                    newgame(nowg);
                    return 1;
                } else {
                    return 0;
                }
            }
            return 1;
        }
        function keyDownHandler(e) {
            if (e.key == "ArrowRight") {
                key_right = true;
            }
            else if (e.key == "ArrowLeft") {
                key_left = true;
            }
            else if (e.key == " ") {
                suon.currentTime = 0;
                suon.play();
                block_up = true;
            }
        }
        function keyUpHandler(e) {
            if (e.key == "ArrowRight") {
                key_right = false;
            }
            else if (e.key == "ArrowLeft") {
                key_left = false;
            }
        }
        function click(e) {
            var x = e.pageY;
            if (x < 600) {
                suon.currentTime = 0;
                suon.play();
                block_up = true;
            }
        }
        function touchstart(e) {
            var touches = e.changedTouches;

            if (jx * 60   > touches[0].pageX) key_left = true;
            if (jx * 60 + 60 < touches[0].pageX) key_right = true;
            pjx = touches[0].pageX;
            pjy = touches[0].pageY;

            console.log(touches[0].pageX)
        }
        function touchend(e) {
            key_left = false;
            key_right = false;
            pjx = 0;
            pjy = 0;
        }
        function touchmove(e) {
            var touches = e.changedTouches;
            if (jx * 60  > touches[0].pageX) key_left = true;
            if (jx * 60 + 60 < touches[0].pageX) key_right = true;
            pjx = touches[0].pageX;
            pjy = touches[0].pageY;
            console.log(touches[0].pageX)
        }
        var words = [
            "milk", "牛乳",
            "coffee", "コーヒー",
            "pencil", "鉛筆",
            "zoo", "動物園",
            "人々", "people",
            "cat", "猫",
            "dog", "犬",
            "apple", "りんご",
            "book", "本",
            "orange", "オレンジ",
            "desk", "机",
            "note", "ノート",
            "green", "緑",
            "blue", "青",
            "japan", "日本",
            "girl", "少女",
            "fish", "魚",
            "egg", "卵",
            
        ];
    </script>


</body></html>